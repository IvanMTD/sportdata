<div class="container">
    <!-- Банер регистрация соревнования-->
    <div class="row">
        <div class="col">
            <p class="fs-2 text-secondary">Регистрация соревнования</p>
        </div>
    </div>
    <!-- Карточка для заполнения -->
    <form th:method="POST" th:action="@{/contest/last-step}" th:object="${contest}">
        <input type="number" th:field="*{id}" hidden>
        <input type="checkbox" id="complete" th:field="*{complete}" hidden>
        <div class="row rounded-4 shadow" th:each="as, as_stat : ${contest.getSports()}"
             th:id="'contest-card-' + ${as_stat.index}" hidden>
            <!-- Картинка -->
            <div class="col-3 p-0 img-bg-control-1 rounded-start-4" style="overflow: hidden">
            </div>
            <!-- Форма -->
            <div class="col-9 px-4">
                <input type="number" th:id="'as_h-' + ${as_stat.index}" th:field="*{sports[__${as_stat.index}__].id}"
                       hidden>
                <script th:inline="javascript">
                    $('#as-h-' + [[${as_stat.index}]]).val([[${as}]].id);
                </script>
                <!-- Начало заполнения - банер -->
                <div class="row">
                    <p class="fs-3 text-secondary text-center">Результаты соревнования</p>
                </div>
                <!-- Первая строка -->
                <div class="row">
                    <div class="col-5">
                        <div class="form-floating">
                            <select class="form-select" th:id="'discipline-id-' + ${as_stat.index}"
                                    th:field="*{sports[__${as_stat.index}__].disciplineId}">
                                <option th:each="discipline : ${sport.getDisciplines()}"
                                        th:value="${discipline.getId()}"
                                        th:text="${discipline.getTitle()}"></option>
                            </select>
                            <label th:for="'discipline-id-' + ${as_stat.index}">Дисциплина</label>
                        </div>
                    </div>
                    <div class="col-1 mt-1">
                        <button th:id="'btn-update-disciplines-' + ${as_stat.index}" type="button"
                                class="btn btn-lg btn-outline-secondary" onclick="updateDisciplines(this.id)">
                            <div th:id="'icon-update-discipline-' + ${as_stat.index}">
                                <i class="bi bi-arrow-repeat"></i>
                            </div>
                        </button>
                    </div>
                    <div class="col-5">
                        <div class="form-floating">
                            <select class="form-select" th:id="'group-id-' + ${as_stat.index}"
                                    th:field="*{sports[__${as_stat.index}__].groupId}">
                                <option th:each="group : ${sport.getGroups()}" th:value="${group.getId()}"
                                        th:text="${group.getTitle()} + ' ' + ${group.getMinAge()} + '-' + ${group.getMaxAge()}"></option>
                            </select>
                            <label th:for="'group-id-' + ${as_stat.index}">Возрастная группа</label>
                        </div>
                    </div>
                    <div class="col-1 mt-1">
                        <button th:id="'btn-update-groups-' + ${as_stat.index}" type="button"
                                class="btn btn-lg btn-outline-secondary" onclick="updateGroups(this.id)">
                            <div th:id="'icon-update-groups-' + ${as_stat.index}">
                                <i class="bi bi-arrow-repeat"></i>
                            </div>
                        </button>
                    </div>
                </div>
                <!-- Вторая строка -->
                <div class="row">
                    <!-- Допуски -->
                    <div class="col">
                        <div class="d-grid gap-2 mt-3">
                            <!-- Button trigger modal -->
                            <button th:id="'category-modal-btn-' + ${as_stat.index}" type="button"
                                    class="btn btn-lg btn-outline-secondary" data-bs-toggle="modal"
                                    data-bs-target="#category-modal-">
                                Допуски
                            </button>
                            <!-- Modal -->
                            <div class="modal fade" th:id="'category-modal-' + ${as_stat.index}" tabindex="-1"
                                 aria-labelledby="modalLabel-0" aria-hidden="true">
                                <div class="modal-dialog  modal-dialog-centered">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h1 class="modal-title fs-5" id="modalLabel-0">Укажите допуски</h1>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                    aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            <div class="row">
                                                <div class="col" id="categories-0">
                                                    <div th:each="category, c_stat : ${categories}">
                                                        <div class="form-check">
                                                            <input th:id="'a-' + ${as_stat.index} + '-' + ${c_stat.index}"
                                                                   type="checkbox" class="form-check-input"
                                                                   th:value="${category.getCategory()}"
                                                                   th:field="*{sports[__${as_stat.index}__].allowed[__${c_stat.index}__]}">
                                                            <label class="form-check-label"
                                                                   th:text="${category.getCategory().getTitle()}"></label>
                                                            <script th:inline="javascript">
                                                                for (let i = 0; i < [[${as}]].allowed.length; i++) {
                                                                    if ([[${as}]].allowed[i] === [[${category}]].category) {
                                                                        document.getElementById('a-' + [[${as_stat.index}]] + '-' + [[${c_stat.index}]]).checked = true;
                                                                    }
                                                                }
                                                            </script>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                                                Вернуться
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <script th:inline="javascript">
                                document.getElementById('category-modal-btn-' + [[${as_stat.index}]]).setAttribute('data-bs-target', '#category-modal-' + [[${as_stat.index}]]);
                            </script>
                        </div>
                    </div>
                    <!-- ФССП -->
                    <div class="col">
                        <div class="d-grid gap-2 mt-3">
                            <!-- Button trigger modal -->
                            <button th:id="'fssp-modal-btn-' + ${as_stat.index}" type="button"
                                    class="btn btn-lg btn-outline-secondary" data-bs-toggle="modal"
                                    data-bs-target="#fssp-modal-">
                                ФССП
                            </button>
                            <!-- Modal -->
                            <div class="modal fade" th:id="'fssp-modal-' + ${as_stat.index}" tabindex="-1"
                                 aria-labelledby="fsspModalLabel-0" aria-hidden="true">
                                <div class="modal-dialog  modal-dialog-centered">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h1 class="modal-title fs-5" id="fsspModalLabel-0">Укажите ФССП</h1>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                    aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            <div class="row">
                                                <div class="col" id="fssp-0">
                                                    <div th:each="standard, s_stat : ${federalStandards}">
                                                        <div class="form-check">
                                                            <input th:id="'f-' + ${as_stat.index} + '-' + ${s_stat.index}"
                                                                   type="checkbox" class="form-check-input"
                                                                   th:value="${standard.getFederalStandard()}"
                                                                   th:field="*{sports[__${as_stat.index}__].standards[__${s_stat.index}__]}">
                                                            <label class="form-check-label"
                                                                   th:text="${standard.getTitle()}"></label>
                                                            <script th:inline="javascript">
                                                                for (let i = 0; i < [[${as}]].standards.length; i++) {
                                                                    if ([[${as}]].standards[i] === [[${standard}]].federalStandard) {
                                                                        document.getElementById('f-' + [[${as_stat.index}]] + '-' + [[${s_stat.index}]]).checked = true;
                                                                    }
                                                                }
                                                            </script>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                                                Вернуться
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <script th:inline="javascript">
                                document.getElementById('fssp-modal-btn-' + [[${as_stat.index}]]).setAttribute('data-bs-target', '#fssp-modal-' + [[${as_stat.index}]]);
                            </script>
                        </div>
                    </div>
                </div>
                <!-- Третья строка -->
                <div class="row mt-3">
                    <div class="col-10">
                        <div class="form-floating">
                            <input th:id="'participant-search-' + ${as_stat.index}"
                                   th:list="'search-data-list-' + ${as_stat.index}" placeholder="search" type="search"
                                   class="form-control" oninput="searchParticipants(this.id)">
                            <datalist th:id="'search-data-list-' + ${as_stat.index}"></datalist>
                            <label th:for="'participant-search-' + ${as_stat.index}">Поиск участника</label>
                        </div>
                    </div>
                    <div class="col mt-1">
                        <div class="d-grid">
                            <button th:id="'add-p-btn-' + ${as_stat.index}" class="btn btn-lg btn-outline-secondary"
                                    type="button" onclick="addParticipant(this.id)">Добавить
                            </button>
                        </div>
                    </div>
                </div>
                <!-- Сюда добавляются финалисты -->
                <div class="row">
                    <div class="col">
                        <div th:id="'participant-container-' + ${as_stat.index}">

                            <div th:if="${as.getPlaces.size() != 0}">
                                <div th:each="place , p_stat : ${as.getPlaces()}">
                                    <input type="number" th:id="'h-p-id-' + ${as_stat.index} + '-' + ${p_stat.index}"
                                           th:value="${place.getId()}"
                                           th:field="*{sports[__${as_stat.index}__].places[__${p_stat.index}__].id}"
                                           hidden>
                                    <script th:inline="javascript">
                                        document.getElementById('h-p-id-' + [[${as_stat.index}]] + '-' + [[${p_stat.index}]]).value = [[${place}]].id;
                                    </script>
                                    <div class="mt-3 rounded-4 bg-success-subtle"
                                         th:id="'container-' + ${as_stat.index} + '-' + ${p_stat.index}">
                                        <div class="row p-4">
                                            <div class="col">
                                                <div class="row">
                                                    <div class="col">
                                                        <div class="form-floating">
                                                            <select class="form-select"
                                                                    th:id="'participant-' + ${as_stat.index} + '-' + ${p_stat.index}"
                                                                    th:field="*{sports[__${as_stat.index}__].places[__${p_stat.index}__].participantId}"
                                                                    onchange="rebuildCategory(this.id)">

                                                            </select>
                                                            <label th:for="'participant-' + ${as_stat.index} + '-' + ${p_stat.index}">Спортсмен</label>
                                                            <script th:inline="javascript">
                                                                $('#participant-' + [[${as_stat.index}]] + '-' + [[${p_stat.index}]]).append(
                                                                    '<option data-item="' + JSON.stringify([[${place}]]).replace(/"/g, '&quot;') + '" value="' + [[${place}]].participant.id + '">' + [[${place}]].participant.fullName + ' | Год рождения: ' + [[${place}]].participant.date + ' | Возраст: ' + [[${place}]].participant.age + '</option>'
                                                                );
                                                                document.getElementById('participant-' + [[${as_stat.index}]] + '-' + [[${p_stat.index}]]).value = [[${place}]].participantId
                                                            </script>
                                                        </div>
                                                    </div>
                                                    <div class="col">
                                                        <div class="form-floating">
                                                            <select th:id="'school-' + ${as_stat.index} + '-' + ${p_stat.index}"
                                                                    class="form-select"
                                                                    th:field="*{sports[__${as_stat.index}__].places[__${p_stat.index}__].schoolId}">

                                                            </select>
                                                            <label th:for="'school-' + ${as_stat.index} + '-' + ${p_stat.index}">Спортивная
                                                                организация</label>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="row pt-3">
                                                    <div class="col">
                                                        <div class="form-floating">
                                                            <select th:id="'qualification-' + ${as_stat.index} + '-' + ${p_stat.index}"
                                                                    class="form-select"
                                                                    th:field="*{sports[__${as_stat.index}__].places[__${p_stat.index}__].qualificationId}">

                                                            </select>
                                                            <label th:for="'qualification-' + ${as_stat.index} + '-' + ${p_stat.index}">Квалификация</label>
                                                        </div>
                                                    </div>
                                                    <script th:inline="javascript">
                                                        console.log(JSON.parse(document.getElementById('participant-' + [[${as_stat.index}]] + '-' + [[${p_stat.index}]]).options[document.getElementById('participant-' + [[${as_stat.index}]] + '-' + [[${p_stat.index}]]).selectedIndex].getAttribute('data-item').replace(/&quot;/g, '"')));
                                                        $('#school-' + [[${as_stat.index}]] + '-' + [[${p_stat.index}]]).append(
                                                            '<option value="' + JSON.parse(document.getElementById('participant-' + [[${as_stat.index}]] + '-' + [[${p_stat.index}]]).options[document.getElementById('participant-' + [[${as_stat.index}]] + '-' + [[${p_stat.index}]]).selectedIndex].getAttribute('data-item').replace(/&quot;/g, '"')).school.id + '">' + JSON.parse(document.getElementById('participant-' + [[${as_stat.index}]] + '-' + [[${p_stat.index}]]).options[document.getElementById('participant-' + [[${as_stat.index}]] + '-' + [[${p_stat.index}]]).selectedIndex].getAttribute('data-item').replace(/&quot;/g, '"')).school.subject.title + ' - ' + JSON.parse(document.getElementById('participant-' + [[${as_stat.index}]] + '-' + [[${p_stat.index}]]).options[document.getElementById('participant-' + [[${as_stat.index}]] + '-' + [[${p_stat.index}]]).selectedIndex].getAttribute('data-item').replace(/&quot;/g, '"')).school.title + '</option>'
                                                        );
                                                        $('#qualification-' + [[${as_stat.index}]] + '-' + [[${p_stat.index}]]).append(
                                                            '<option value="' + JSON.parse(document.getElementById('participant-' + [[${as_stat.index}]] + '-' + [[${p_stat.index}]]).options[document.getElementById('participant-' + [[${as_stat.index}]] + '-' + [[${p_stat.index}]]).selectedIndex].getAttribute('data-item').replace(/&quot;/g, '"')).qualification.id + '">' + JSON.parse(document.getElementById('participant-' + [[${as_stat.index}]] + '-' + [[${p_stat.index}]]).options[document.getElementById('participant-' + [[${as_stat.index}]] + '-' + [[${p_stat.index}]]).selectedIndex].getAttribute('data-item').replace(/&quot;/g, '"')).qualification.categoryTitle + ' - ' + [[${contest}]].sport.title + '</option>'
                                                        );
                                                        document.getElementById('school-' + [[${as_stat.index}]] + '-' + [[${p_stat.index}]]).value = [[${place}]].schoolId;
                                                        document.getElementById('qualification-' + [[${as_stat.index}]] + '-' + [[${p_stat.index}]]).value = [[${place}]].qualificationId;
                                                    </script>
                                                    <div class="col">
                                                        <div class="form-floating">
                                                            <select th:id="'prise-' + ${as_stat.index} + '-' + ${p_stat.index}"
                                                                    class="form-select"
                                                                    th:field="*{sports[__${as_stat.index}__].places[__${p_stat.index}__].place}">
                                                                <option value="1">1</option>
                                                                <option value="2">2</option>
                                                                <option value="3">3</option>
                                                            </select>
                                                            <label th:for="'prise-' + ${as_stat.index} + '-' + ${p_stat.index}">Занял
                                                                место</label>
                                                        </div>
                                                    </div>
                                                    <div class="col">
                                                        <div class="form-floating">
                                                            <select th:id="'condition-' + ${as_stat.index} + '-' + ${p_stat.index}"
                                                                    class="form-select"
                                                                    th:field="*{sports[__${as_stat.index}__].places[__${p_stat.index}__].condition}">
                                                                <option th:each="condition : ${conditions}"
                                                                        th:value="${condition.getCondition()}"
                                                                        th:text="${condition.getTitle()}"></option>
                                                            </select>
                                                            <label th:for="'condition-' + ${as_stat.index} + '-' + ${p_stat.index}">ЕВСК</label>
                                                        </div>
                                                    </div>
                                                    <div class="col">
                                                        <div class="form-floating">
                                                            <select th:id="'nq-' + ${as_stat.index} + '-' + ${p_stat.index}"
                                                                    class="form-select"
                                                                    th:field="*{sports[__${as_stat.index}__].places[__${p_stat.index}__].newQualificationData}">
                                                                <option th:each="category : ${categories}"
                                                                        th:value="${category.getCategory()}"
                                                                        th:text="${category.getTitle()}"></option>
                                                            </select>
                                                            <label th:for="'nq-' + ${as_stat.index} + '-' + ${p_stat.index}">Состояние</label>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="row pt-3">
                                                    <div class="col">
                                                        <div class="form-floating">
                                                            <select th:id="'parallel-school-' + ${as_stat.index} + '-' + ${p_stat.index}" class="form-select" th:field="*{sports[__${as_stat.index}__].places[__${p_stat.index}__].parallelSchoolId}">
                                                                <option value="0">Отсутствует</option>
                                                            </select>
                                                            <script th:inline="javascript">
                                                                if([[${place.parallelSchoolId}]] != 0) {
                                                                    $('#parallel-school-' + [[${as_stat.index}]] + '-' + [[${p_stat.index}]]).empty();
                                                                    $('#parallel-school-' + [[${as_stat.index}]] + '-' + [[${p_stat.index}]]).append(
                                                                        '<option value="' + JSON.parse(document.getElementById('participant-' + [[${as_stat.index}]] + '-' + [[${p_stat.index}]]).options[document.getElementById('participant-' + [[${as_stat.index}]] + '-' + [[${p_stat.index}]]).selectedIndex].getAttribute('data-item').replace(/&quot;/g, '"')).parallelSchoolId + '">' + JSON.parse(document.getElementById('participant-' + [[${as_stat.index}]] + '-' + [[${p_stat.index}]]).options[document.getElementById('participant-' + [[${as_stat.index}]] + '-' + [[${p_stat.index}]]).selectedIndex].getAttribute('data-item').replace(/&quot;/g, '"')).parallelSchool.subject.title + ' - ' + JSON.parse(document.getElementById('participant-' + [[${as_stat.index}]] + '-' + [[${p_stat.index}]]).options[document.getElementById('participant-' + [[${as_stat.index}]] + '-' + [[${p_stat.index}]]).selectedIndex].getAttribute('data-item').replace(/&quot;/g, '"')).parallelSchool.title + '</option>' +
                                                                        '<option value="0">Отсутсвует</option>'
                                                                    );
                                                                }
                                                            </script>
                                                            <label th:for="'parallel-school-' + ${as_stat.index} + '-' + ${p_stat.index}">Параллельный зачет</label>
                                                        </div>
                                                    </div>
                                                    <div class="col">
                                                        <div class="form-floating">
                                                            <input type="text" th:id="'info-' + ${as_stat.index} + '-' + ${p_stat.index}" placeholder="info" class="form-control" th:field="*{sports[__${as_stat.index}__].places[__${p_stat.index}__].info}">
                                                            <label th:for="'info-' + ${as_stat.index} + '-' + ${p_stat.index}">Дополнительная информация</label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-1">
                                                <div class="container d-flex justify-content-center align-items-center"
                                                     style="height: 100%">
                                                    <button th:id="'delete-' + ${as_stat.index} + '-' + ${p_stat.index} + '-' + ${place.getId()}"
                                                            type="button" class="btn-close mx-auto text-center border"
                                                            aria-label="Close"
                                                            onclick="deleteParticipantFromDB(this.id)" th:if="${admin} or ${manager}"></button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row py-4">
                    <div class="d-grid gap-2 col-4 mx-auto">
                        <a class="btn btn-outline-secondary btn-lg"
                           th:href="@{/contest/second-step(contest=${contest.getId()})}">Назад</a>
                    </div>
                    <div class="d-grid gap-2 col-4 mx-auto">
                        <button class="btn btn-outline-secondary btn-lg" type="submit" onclick="contestEdit()">Добавить
                            дисциплину
                        </button>
                    </div>
                    <div class="d-grid gap-2 col-4 mx-auto">
                        <button class="btn btn-outline-secondary btn-lg" type="submit" onclick="contestDone()">Завершить |
                            Сохранить
                        </button>
                    </div>
                    <script>
                        function contestDone() {
                            document.getElementById('complete').checked = true;
                        }

                        function contestEdit() {
                            document.getElementById('complete').checked = false;
                        }
                    </script>
                </div>

                <div class="row pb-4">
                    <div class="col">
                        <div class="d-grid gap-2">
                            <!-- Button trigger modal -->
                            <button type="button" th:id="'discipline-modal-del-' + ${as_stat.index}" class="btn btn-outline-secondary btn-lg" data-bs-toggle="modal" data-bs-target="#modal-" th:if="${admin} or ${manager}">
                                Удалить дисциплину
                            </button>

                            <!-- Modal -->
                            <div class="modal fade" th:id="'modal-' + ${as_stat.index}" tabindex="-1" aria-labelledby="modal" aria-hidden="true">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h1 class="modal-title fs-5" id="exampleModalLabel">Внимание! Удаление!</h1>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            <p>Вы собираетесь удалить дисциплину! Вы уверены?</p>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                                            <a class="btn btn-danger" th:href="@{/contest/last-step/discipline/delete(discipline=${as.id}, contest=${contest.id})}">Подтвердить</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <script th:inline="javascript">
                                document.getElementById('discipline-modal-del-' + [[${as_stat.index}]]).setAttribute('data-bs-target','#modal-' + [[${as_stat.index}]]);
                            </script>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
    <!-- Кнопки перехода между карточками -->
    <div class="row">
        <div class="col-1" th:each="as, as_stat : ${contest.getSports()}">
            <button th:id="'card-btn-' + ${as_stat.index}" type="button"
                    class="btn btn-lg btn-outline-secondary mt-3 d-flex justify-content-center align-items-center square-btn"
                    th:if="${as_stat.index + 1} != ${contest.getSports().size()}" onclick="openCard(this.id)">
                <p class="text-center fs-4 m-0" th:text="${as_stat.index + 1}"></p>
            </button>
            <button th:id="'card-btn-' + ${as_stat.index}" type="button"
                    class="btn btn-lg btn-secondary mt-3 d-flex justify-content-center align-items-center square-btn"
                    th:if="${as_stat.index + 1} == ${contest.getSports().size()}" onclick="openCard(this.id)">
                <p class="text-center fs-4 m-0" th:text="${as_stat.index + 1}"></p>
            </button>
        </div>
    </div>
</div>

<script th:inline="javascript">
    let index = ([[${contest.getSports().size()}]] - 1)
    let sport = [[${sport}]];
    let pCount = 0;
    let check = 0;

    document.getElementById('contest-card-' + index).hidden = false;

    function updateDisciplines(btnId) {
        let parts = btnId.split('-'); // Разделяем строку по символу '-'
        let count = parts[parts.length - 1]; // Получаем последний элемент массива
        let disciplineSelect = $('#discipline-id-' + count);

        // Начинаем анимацию вращения
        $('#icon-update-discipline-' + count).addClass('rotate-icon');

        // Задержка выполнения кода на 0.5 секунды
        setTimeout(function () {
            $.ajax({
                url: '/rest/database/get/disciplines',
                type: 'get',
                data: {
                    query: sport.id
                },
                success: function (disciplines) {
                    disciplineSelect.empty();
                    disciplines.forEach(function (discipline) {
                        disciplineSelect.append(
                            '<option value="' + discipline.id + '">' + discipline.title + '</option>'
                        );
                    });

                    // Останавливаем анимацию вращения
                    $('#icon-update-discipline-' + count).removeClass('rotate-icon');
                }
            });
        }, 500);
    }

    function updateGroups(btnId) {
        let parts = btnId.split('-'); // Разделяем строку по символу '-'
        let count = parts[parts.length - 1]; // Получаем последний элемент массива
        let groupsSelect = $('#group-id-' + count);

        // Начинаем анимацию вращения
        $('#icon-update-groups-' + count).addClass('rotate-icon');

        // Задержка выполнения кода на 0.5 секунды
        setTimeout(function () {
            $.ajax({
                url: '/rest/database/get/groups',
                type: 'get',
                data: {
                    query: sport.id
                },
                success: function (groups) {
                    groupsSelect.empty();
                    groups.forEach(function (group) {
                        groupsSelect.append(
                            '<option value="' + group.id + '">' + group.title + ' ' + group.minAge + '-' + group.maxAge + '</option>'
                        );
                    });

                    // Останавливаем анимацию вращения
                    $('#icon-update-groups-' + count).removeClass('rotate-icon');
                }
            });
        }, 500);
    }

    function searchParticipants(searchFiledId) {
        let stringList = searchFiledId.split('-');
        let index = stringList[stringList.length - 1];
        $.ajax({
            url: '/rest/database/sport-participants',
            type: 'get',
            data: {
                search: $('#' + searchFiledId).val(),
                sportId: [[${contest}]].sportId
            },
            success: function (participants) {
                let dataList = $('#search-data-list-' + index);
                dataList.empty();

                participants.forEach(function (p) {
                    dataList.append(
                        '<option data-item="' + JSON.stringify(p).replace(/"/g, '&quot;') + '" value="' + p.lastname + ' ' + p.name + ' ' + p.middleName + '">' + p.birthday + ' | Возраст: ' + p.age + '</option>'
                    );
                });
            }
        });
    }

    function addParticipant(btnId) {
        let parts = btnId.split('-');
        let index = parts[parts.length - 1];
        if (check === 0) {
            pCount = [[${contest}]].sports[index].places.length;
            check = 1;
        }

        let pValue = $('#participant-search-' + index).val();
        let searchOptions = document.getElementById('search-data-list-' + index).options;
        let participant = null;
        for (let i = 0; i < searchOptions.length; i++) {
            if (searchOptions[i].value === pValue) {
                participant = JSON.parse(searchOptions[i].getAttribute('data-item').replace(/&quot;/g, '"'));
                console.log(participant);
                break;
            }
        }

        if (participant != null) {
            let participantContainer = $('#participant-container-' + index);
            participantContainer.append(
                '<div class="mt-3 rounded-4 bg-success-subtle" id="container-' + index + '-' + pCount + '">' +
                '<div class="row p-4">' +
                '   <div class="col">' +
                '       <div class="row">' +
                '          <div class="col">' +
                '              <div class="form-floating">' +
                '                  <input type="text" class="form-control" value="' + participant.fullName + ' | Год рождения: ' + participant.date + ' | Вораст: ' + participant.age + '" disabled>' +
                '                  <input type="number" name="sports[' + index + '].places[' + pCount + '].participantId" value="' + participant.id + '" placeholder="pid" id="participant-' + index + '-' + pCount + '" class="form-control" hidden>' +
                '                  <label for="participant-' + index + '-' + pCount + '">Спортсмен</label>' +
                '              </div>' +
                '          </div>' +
                '          <div class="col">' +
                '              <div class="form-floating">' +
                '                  <select name="sports[' + index + '].places[' + pCount + '].schoolId" id="school-' + index + '-' + pCount + '" class="form-select"></select>' +
                '                  <label for="school-' + index + '-' + pCount + '">Спортивная организация</label>' +
                '              </div>' +
                '          </div>' +
                '       </div>' +
                '       <div class="row pt-3">' +
                '          <div class="col">' +
                '              <div class="form-floating">' +
                '                  <select name="sports[' + index + '].places[' + pCount + '].qualificationId" id="qualification-' + index + '-' + pCount + '" class="form-select"></select>' +
                '                  <label for="qualification-' + index + '-' + pCount + '">Квалификация</label>' +
                '              </div>' +
                '          </div>' +
                '          <div class="col">' +
                '              <div class="form-floating">' +
                '                           <select name="sports[' + index + '].places[' + pCount + '].place" id="prise-' + index + '-' + pCount + '" class="form-select">' +
                '                               <option value="1" selected>1</option>' +
                '                               <option value="2">2</option>' +
                '                               <option value="3">3</option>' +
                '                           </select>' +
                '                           <label for="prise-' + index + '-' + pCount + '">Занял место</label>' +
                '                       </div>' +
                '                   </div>' +
                '                   <div class="col">' +
                '                       <div class="form-floating">' +
                '                           <select name="sports[' + index + '].places[' + pCount + '].condition" id="condition-' + index + '-' + pCount + '" class="form-select">' +
                '                           </select>' +
                '                           <label for="condition-' + index + '-' + pCount + '">ЕВСК</label>' +
                '                       </div>' +
                '                   </div>' +
                '                   <div class="col">' +
                '                       <div class="form-floating">' +
                '                           <select name="sports[' + index + '].places[' + pCount + '].newQualificationData" id="nq-' + index + '-' + pCount + '" class="form-select">' +
                '                           </select>' +
                '                           <label for="nq-' + index + '-' + pCount + '">Состояние</label>' +
                '                       </div>' +
                '                   </div>' +
                '               </div>' +
                '               <div class="row pt-3">' +
                '                   <div class="col">' +
                '                       <div class="col">' +
                '                           <div class="form-floating">' +
                '                               <select name="sports[' + index + '].places[' + pCount + '].parallelSchoolId" id="parallel-school-' + index + '-' + pCount + '" class="form-select">' +
                '                                   <option value="0">Отсутствует</option>' +
                '                               </select>' +
                '                               <label for="parallel-school-' + index + '-' + pCount + '">Параллельный зачет</label>' +
                '                           </div>' +
                '                       </div>' +
                '                   </div>' +
                '                   <div class="col">' +
                '                       <div class="col">' +
                '                           <div class="form-floating">' +
                '                               <input type="text" name="sports[' + index + '].places[' + pCount + '].info" id="info-' + index + '-' + pCount + '" placeholder="info" class="form-control">' +
                '                               <label for="info-' + index + '-' + pCount + '">Дополнительная информация</label>' +
                '                           </div>' +
                '                       </div>' +
                '                   </div>' +
                '               </div>' +
                '           </div>' +
                '       <div class="col-1">' +
                '           <div class="container d-flex justify-content-center align-items-center" style="height: 100%">' +
                '               <button id="del-' + index + '-' + pCount + '" type="button" class="btn-close mx-auto text-center border" aria-label="Close" onclick="deleteParticipant(this.id)"></button>' +
                '           </div>' +
                '       </div>' +
                '   </div>' +
                '</div>'
            );

            participant.qualifications.forEach(function (qualification) {
                $('#qualification-' + index + '-' + pCount).append(
                    '<option value="' + qualification.id + '">' + qualification.categoryTitle + ' - ' + qualification.sport.title + '</option>'
                );
            });

            participant.schools.forEach(function (school) {
                $('#school-' + index + '-' + pCount).append(
                    '<option value="' + school.id + '">' + school.subject.title + ' - ' + school.title + '</option>'
                );
                $('#parallel-school-' + index + '-' + pCount).append(
                    '<option value="' + school.id + '">' + school.subject.title + ' - ' + school.title + '</option>'
                );
            });

            [[${categories}]].forEach(function (category) {
                $('#nq-' + index + '-' + pCount).append(
                    '<option value="' + category.category + '">' + category.title + '</option>'
                );
            });

            [[${conditions}]].forEach(function (condition) {
                $('#condition-' + index + '-' + pCount).append(
                    '<option value="' + condition.condition + '">' + condition.title + '</option>'
                );
            });

            pCount++;
        }
    }

    function rebuildCategory(selectId) {
        let parts = selectId.split('-');
        let index1 = parseInt(parts[parts.length - 2]);
        let index2 = parseInt(parts[parts.length - 1]);
        let select = document.getElementById(selectId);
        let option = select.options[select.selectedIndex];
        let participant = JSON.parse(option.getAttribute('data-item').replace(/&quot;/g, '"'));
        let qualifications = participant.qualifications;
        let schools = participant.schools;
        $('#qualification-' + index1 + '-' + index2).empty();
        qualifications.forEach(function (qualification) {
            $('#qualification-' + index1 + '-' + index2).append(
                '<option value="' + qualification.id + '">' + qualification.categoryTitle + ' - ' + qualification.sport.title + '</option>'
            );
        });
        $('#school-' + index1 + '-' + index2).empty();
        schools.forEach(function (school) {
            $('#school-' + index1 + '-' + index2).append(
                '<option value="' + school.id + '">' + school.subject.title + ' - ' + school.title + '</option>'
            );
        });
    }

    function deleteParticipant(delId2) {
        console.log(delId2);
        let parts = delId2.split('-');
        let index1 = parseInt(parts[parts.length - 2]);
        let index2 = parseInt(parts[parts.length - 1]);
        let container = $('#container-' + index1 + '-' + index2);
        container.remove();
    }

    function deleteParticipantFromDB(delBtnId) {
        let part = delBtnId.split('-');
        let index1 = part[part.length - 3];
        let index2 = part[part.length - 2];
        let placeId = part[part.length - 1];
        $.ajax({
            url: '/rest/database/place/delete',
            type: 'get',
            data: {
                query: placeId
            },
            success: function (response) {
                console.log(response);
                $('#container-' + index1 + '-' + index2).remove();
            }
        });
    }

    function openCard(btnId) {
        let part = btnId.split('-');
        let index = part[part.length - 1];
        let list = [[${contest}]].sports;
        for (let i = 0; i < list.length; i++) {
            if (i == index) {
                document.getElementById('contest-card-' + i).hidden = false;
                let button = document.getElementById('card-btn-' + i);
                button.classList.remove("btn-outline-secondary");
                button.classList.add("btn-secondary");
            } else {
                document.getElementById('contest-card-' + i).hidden = true;
                let button = document.getElementById('card-btn-' + i);
                button.classList.remove("btn-secondary");
                button.classList.add("btn-outline-secondary");
            }
        }
    }
</script>